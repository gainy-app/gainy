version: 1
send_anonymous_usage_stats: false
project_id: 36bd814f-1cb5-402a-8d9c-d3219c38f2b3
plugins:
  extractors:
    - name: tap-eodhistoricaldata
      namespace: tap_eodhistoricaldata
      pip_url: /tap-eodhistoricaldata
      executable: tap-eodhistoricaldata
      capabilities:
        - discover
        - catalog
        - state
      settings:
        - name: api_token
        - name: streams
          kind: array
        - name: exchanges
          kind: array
        - name: exchange_symbols_limit
          kind: integer
        - name: symbols
          kind: array
        - name: symbols_type
        - name: split_id
        - name: split_num
      config:
        streams:
          - eod_fundamentals
          - eod_options

    - name: tap-eodhistoricaldata-prices
      inherit_from: tap-eodhistoricaldata
      config:
        streams:
          - eod_dividends
          - eod_historical_prices

    - name: tap-polygon
      namespace: tap_polygon
      pip_url: /tap-polygon
      executable: tap-polygon
      capabilities:
        - discover
        - catalog
        - state
      settings:
        - name: api_key

    - name: tap-coingecko
      namespace: tap_coingecko
      pip_url: /tap-coingecko
      executable: tap-coingecko
      settings:
        - name: api_key
        - name: split_id
        - name: split_num
        - name: realtime
      capabilities:
        - discover
        - catalog
        - state

    - name: tap-coingecko-realtime
      inherit_from: tap-coingecko
      config:
        realtime: true

    - name: tap-csv
      config:
        files:
          - entity: gainy_industries
            path: data/gainy_industries.csv
            keys: [ "id" ]
          - entity: gainy_ticker_industries
            path: data/industry_tickers.csv
            keys: [ "Code" ]
          - entity: gainy_collections
            path: data/collections.csv
            keys: [ "id" ]
          - entity: gainy_categories
            path: data/categories.csv
            keys: [ "id" ]
          - entity: gainy_interests
            path: data/interests.csv
            keys: [ "id" ]
          - entity: gainy_countries
            path: data/countries.csv # https://github.com/lukes/ISO-3166-Countries-with-Regional-Codes/blob/master/all/all.json
            keys: [ "name", "alpha-2", "alpha-3" ]
          - entity: exchanges
            path: data/exchanges.csv
            keys: [ "name" ]

    - name: tap-postgres
      config:
        itersize: 20000

    # sync taps
    - name: tap-postgres-sync
      inherit_from: tap-postgres
      catalog: catalog/raw-sync/tap.catalog.json
    - name: tap-postgres-sync-fundamentals
      inherit_from: tap-postgres-sync
      catalog: catalog/raw-sync/tap.catalog.fundamentals.json
      config:
        itersize: 1
    - name: tap-postgres-sync-options
      inherit_from: tap-postgres-sync
      catalog: catalog/raw-sync/tap.catalog.options.json
      config:
        itersize: 10

    # Algolia tap
    - name: tap-postgres-search
      inherit_from: tap-postgres
      catalog: catalog/search/tap.catalog.json

    # Analytics tap
    - name: tap-postgres-analytics
      inherit_from: tap-postgres
      catalog: catalog/analytics/tap.catalog.json

    - name: tap-postgres-analytics-small-batch
      inherit_from: tap-postgres-analytics
      catalog: catalog/analytics/tap-small-batch.catalog.json
      config:
        itersize: 1

    # Website tap
    - name: tap-postgres-website
      inherit_from: tap-postgres
      catalog: catalog/website/tap.catalog.json
      config:
        filter_schemas: website

  loaders:
    - name: target-postgres
      variant: transferwise
      pip_url: pipelinewise-target-postgres
      config:
        batch_size_rows: 10000
        primary_key_required: false
        add_metadata_columns: true

    - name: target-postgres-small-batch
      inherit_from: target-postgres
      config:
        batch_size_rows: 100
        parallelism: 5

    - name: target-algolia
      namespace: target-algolia
      pip_url: /target-algolia
      config:
        app_id: $ALGOLIA_APP_ID
        api_key: $ALGOLIA_INDEXING_API_KEY
        index_mapping_file: catalog/search/search.mapping.yml
        add_record_metadata: true

    - name: target-postgres-analytics
      inherit_from: target-postgres
      config:
        default_target_schema: $TARGET_POSTGRES_ANALYTICS_SCHEMA

    - name: target-postgres-analytics-small-batch
      inherit_from: target-postgres-small-batch
      config:
        default_target_schema: $TARGET_POSTGRES_ANALYTICS_SCHEMA

  transformers:
    - name: dbt
      pip_url: dbt-postgres==1.0.2
      config:
        target: postgres
        models: '*'

  orchestrators:
    - name: airflow
      pip_url: psycopg2-binary==2.9.3 apache-airflow==2.2.4 --constraint https://raw.githubusercontent.com/apache/airflow/constraints-2.2.4/constraints-${MELTANO__PYTHON_VERSION}.txt
      config:
        core:
          sql_alchemy_conn: $AIRFLOW_DATABASE_URI
          executor: LocalExecutor
        logging:
          logging_level: $AIRFLOW_LOG_LEVEL
        scheduler:
          scheduler_health_check_threshold: 120

schedules:
  - name: csv-to-postgres
    extractor: tap-csv
    loader: target-postgres
    transform: run
    interval: '@daily'
    start_date: 2021-09-03 13:52:48.598227

  - name: polygon-to-postgres
    extractor: tap-polygon
    loader: target-postgres
    transform: skip
    interval: '@daily'
    start_date: 2021-09-03 13:52:48.598227
    env:
      TARGET_ENVS: '["production","local"]'

  - name: eodhistoricaldata-to-postgres-0
    extractor: tap-eodhistoricaldata
    loader: target-postgres-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-06-17 10:40:58.742133
    env:
      TARGET_ENVS: '["production"]'

  - name: eodhistoricaldata-prices-to-postgres-0
    extractor: tap-eodhistoricaldata-prices
    loader: target-postgres
    transform: skip
    interval: '@daily'
    start_date: 2021-06-17 10:40:58.742133
    env:
      TARGET_ENVS: '["production"]'

  - name: coingecko-to-postgres
    extractor: tap-coingecko
    loader: target-postgres-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-06-17 10:40:58.742133
    env:
      TARGET_ENVS: '["production","local"]'

  - name: coingecko-realtime-to-postgres
    extractor: tap-coingecko-realtime
    loader: target-postgres
    transform: skip
    interval: '@daily'
    start_date: 2021-06-17 10:40:58.742133
    env:
      TARGET_ENVS: '[]'

  # Algolia

  - name: postgres-to-search
    extractor: tap-postgres-search
    loader: target-algolia
    transform: skip
    interval: '@daily'
    start_date: 2021-11-15 00:00:00.000000
    env:
      TARGET_ENVS: '["production","test"]'
      INTEGRATION: 'DOWNSTREAM'

  # Analytics

  - name: postgres-to-analytics
    extractor: tap-postgres-analytics
    loader: target-postgres-analytics
    transform: skip
    interval: '@daily'
    start_date: 2021-11-15 00:00:00.000000
    env:
      TARGET_ENVS: '["production","local"]'
      INTEGRATION: 'DOWNSTREAM'

  - name: postgres-to-analytics-small-batch
    extractor: tap-postgres-analytics-small-batch
    loader: target-postgres-analytics-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-11-15 00:00:00.000000
    env:
      TARGET_ENVS: '["production","local"]'
      INTEGRATION: 'DOWNSTREAM'

  # Website

  - name: website-to-postgres
    extractor: tap-postgres-website
    loader: target-postgres-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-11-15 00:00:00.000000
    env:
      TARGET_ENVS: '[]'

  # sync test db

  - name: prod-to-postgres-fundamentals
    extractor: tap-postgres-sync-fundamentals
    loader: target-postgres-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-09-03 13:52:48.598227
    env:
      TARGET_ENVS: '["test"]'

  - name: prod-to-postgres-options
    extractor: tap-postgres-sync-options
    loader: target-postgres-small-batch
    transform: skip
    interval: '@daily'
    start_date: 2021-09-03 13:52:48.598227
    env:
      TARGET_ENVS: '["test"]'

  - name: prod-to-postgres
    extractor: tap-postgres-sync
    loader: target-postgres
    transform: skip
    interval: '@daily'
    start_date: 2021-09-03 13:52:48.598227
    env:
      TARGET_ENVS: '["test"]'
