init_config:

instances:
  - dbm: true
    host: ${pg_host}
    port: ${pg_port}
    username: datadog
    password: ${pg_datadog_password}
    dbname: ${pg_dbname}
    disable_generic_tags: true
    custom_queries:
      - metric_prefix: postgresql
        query: >
          with expanded_dag_runs as
                   (
                       select *,
                              case
                                  when extract(isodow from start_date) < 5
                                      then start_date + interval '1 day'
                                  else date_trunc('week', start_date) +
                                       interval '7 days' +
                                       (start_date -
                                        date_trunc('day', start_date))
                                  end next_run_date
                       from airflow.dag_run
                       where state = 'success'
                         and end_date is not null
                         and dag_id in ('gainy-dag')
                   )
          select distinct on (dag_id) dag_id,
                                      FLOOR(extract(hours from now() - next_run_date + interval '22 hours') / 24
                                          )                                       as days_from_latest_dag_run,
                                      extract(minutes from end_date - start_date) as latest_dag_run_duration_minutes
          from expanded_dag_runs
          order by dag_id, end_date desc
        columns:
          - name: days_from_latest_dag_run
            type: gauge
          - name: latest_dag_run_duration_minutes
            type: gauge
          - name: failed_dag_runs
            type: gauge
          - name: failed_tasks
            type: gauge
        tags:
          - env:${env}
